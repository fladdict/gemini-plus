<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>CSV Manager Tests</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .test-header {
      background-color: #f5f5f5;
      padding: 20px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .test-controls {
      margin-bottom: 20px;
    }
    
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    
    .run-btn {
      background-color: #4CAF50;
      color: white;
    }
    
    .clear-btn {
      background-color: #f44336;
      color: white;
    }
    
    .test-output {
      background-color: #000;
      color: #fff;
      padding: 20px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 14px;
      white-space: pre-wrap;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .passed {
      color: #4CAF50;
    }
    
    .failed {
      color: #f44336;
    }
    
    .warning {
      color: #ff9800;
    }
    
    .info {
      color: #2196F3;
    }
  </style>
</head>
<body>
  <div class="test-header">
    <h1>CSV Manager Unit Tests</h1>
    <p>ã“ã®ãƒšãƒ¼ã‚¸ã¯Gemini+ Chromeæ‹¡å¼µæ©Ÿèƒ½ã®CSVæ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
  </div>
  
  <div class="test-controls">
    <button class="run-btn" onclick="runTests()">ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ</button>
    <button class="clear-btn" onclick="clearOutput()">å‡ºåŠ›ã‚’ã‚¯ãƒªã‚¢</button>
  </div>
  
  <div id="test-output" class="test-output">
    ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€Œãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
  </div>

  <!-- å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿ -->
  <script src="../extension/csv-manager.js"></script>
  <script src="test-framework.js"></script>
  <script src="test-data.js"></script>
  <script src="csv-manager.test.js"></script>
  <script src="context-menu-test.js"></script>
  
  <script>
    let originalConsole = {};
    
    function captureConsole() {
      const output = document.getElementById('test-output');
      
      // å…ƒã®consoleãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä¿å­˜
      originalConsole.log = console.log;
      originalConsole.error = console.error;
      originalConsole.warn = console.warn;
      
      // console.logã‚’ä¸Šæ›¸ã
      console.log = function(...args) {
        const message = args.join(' ');
        output.textContent += message + '\n';
        output.scrollTop = output.scrollHeight;
        
        // å…ƒã®console.logã‚‚å‘¼ã³å‡ºã™
        originalConsole.log.apply(console, args);
      };
      
      // console.errorã‚’ä¸Šæ›¸ã
      console.error = function(...args) {
        const message = args.join(' ');
        output.innerHTML += `<span class="failed">${escapeHtml(message)}</span>\n`;
        output.scrollTop = output.scrollHeight;
        
        // å…ƒã®console.errorã‚‚å‘¼ã³å‡ºã™
        originalConsole.error.apply(console, args);
      };
      
      // console.warnã‚’ä¸Šæ›¸ã
      console.warn = function(...args) {
        const message = args.join(' ');
        output.innerHTML += `<span class="warning">${escapeHtml(message)}</span>\n`;
        output.scrollTop = output.scrollHeight;
        
        // å…ƒã®console.warnã‚‚å‘¼ã³å‡ºã™
        originalConsole.warn.apply(console, args);
      };
    }
    
    function restoreConsole() {
      console.log = originalConsole.log;
      console.error = originalConsole.error;
      console.warn = originalConsole.warn;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function colorizeOutput() {
      const output = document.getElementById('test-output');
      let html = output.innerHTML;
      
      // æˆåŠŸã—ãŸãƒ†ã‚¹ãƒˆã‚’ç·‘è‰²ã«
      html = html.replace(/âœ…/g, '<span class="passed">âœ…</span>');
      
      // å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚’èµ¤è‰²ã«
      html = html.replace(/âŒ/g, '<span class="failed">âŒ</span>');
      
      // è­¦å‘Šã‚’é»„è‰²ã«
      html = html.replace(/âš ï¸/g, '<span class="warning">âš ï¸</span>');
      
      // æƒ…å ±ã‚’é’è‰²ã«
      html = html.replace(/â„¹ï¸/g, '<span class="info">â„¹ï¸</span>');
      
      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å¼·èª¿
      html = html.replace(/=== (.+) ===/g, '<span class="info">=== $1 ===</span>');
      
      output.innerHTML = html;
    }
    
    function runTests() {
      const output = document.getElementById('test-output');
      output.textContent = '';
      
      // consoleã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
      captureConsole();
      
      try {
        // ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        const csvSuccess = runCSVManagerTests();
        const contextSuccess = runContextMenuTests();
        
        const overallSuccess = csvSuccess && contextSuccess;
        
        // çµæœã«åŸºã¥ã„ã¦è‰²åˆ†ã‘
        setTimeout(() => {
          colorizeOutput();
          
          if (overallSuccess) {
            output.innerHTML += '\n<span class="passed">ğŸ‰ ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼</span>';
          } else {
            output.innerHTML += '\n<span class="failed">ğŸ’¥ ã„ãã¤ã‹ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ</span>';
          }
        }, 100);
        
      } catch (error) {
        output.innerHTML += `<span class="failed">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${escapeHtml(error.message)}</span>\n`;
        if (error.stack) {
          output.innerHTML += `<span class="failed">ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ${escapeHtml(error.stack)}</span>\n`;
        }
      } finally {
        // consoleã‚’å¾©å…ƒ
        restoreConsole();
      }
    }
    
    function clearOutput() {
      document.getElementById('test-output').textContent = 'ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€Œãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚';
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    window.addEventListener('load', function() {
      console.log('Test runner loaded. Ready to run tests.');
    });
  </script>
</body>
</html>