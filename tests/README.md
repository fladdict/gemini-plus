# CSV機能のテストスイート

このディレクトリには、Gemini+ Chrome拡張機能のCSVエクスポート/インポート機能に対する包括的なテストスイートが含まれています。

## ファイル構成

```
tests/
├── README.md                 # このファイル
├── test-framework.js         # カスタムテストフレームワーク
├── test-data.js             # テストデータ定義
├── csv-manager.test.js      # CSV機能のテスト
└── test-runner.html         # ブラウザ用テストランナー
```

## テストの実行方法

### ブラウザでのテスト実行

1. Chrome で `test-runner.html` を開く
2. 「テストを実行」ボタンをクリック
3. テスト結果がリアルタイムで表示される

### 開発者向け

```bash
# プロジェクトルートで
cd tests/
# お好みのローカルサーバーで test-runner.html を開く
python -m http.server 8000  # または
npx serve .
```

## テストカバレッジ

### 機能テスト
- ✅ CSV解析の基本機能
- ✅ 引用符処理とエスケープ
- ✅ 多言語文字（日本語）対応
- ✅ フォルダ階層の処理
- ✅ データエクスポート機能
- ✅ メニュー統合機能

### 堅牢性テスト
- ✅ 不正なCSVデータ処理
- ✅ 欠損フィールドの処理
- ✅ ファイルサイズ制限
- ✅ 文字エンコーディング対応
- ✅ メモリ使用量の制限
- ✅ 無限ループ防止

### セキュリティテスト
- ✅ 制御文字のフィルタリング
- ✅ 極端に長いデータの処理
- ✅ 潜在的なXSS攻撃の防止
- ✅ SQLインジェクション風攻撃の処理

### エラーハンドリング
- ✅ ファイル読み込みエラー
- ✅ 形式エラーの適切な処理
- ✅ ユーザーフレンドリーなエラーメッセージ
- ✅ 部分的失敗の処理

## テストデータ

### 正常系テストデータ
- 基本的なCSV形式
- 引用符を含むフィールド
- 複数行フィールド
- 階層フォルダ構造
- 日本語テキスト

### 異常系テストデータ
- ヘッダーなしCSV
- 必須フィールドの欠損
- 不正な引用符
- 無効な適用範囲
- 極端に長いデータ
- 制御文字を含むデータ

### エッジケース
- 空のCSVファイル
- 大量データ（1000行）
- 深い階層構造
- Unicode文字
- 重複データ
- 異なる改行文字

## 発見された問題と修正

### 修正済みの問題
1. **CSV解析の脆弱性**: 不正なクォート処理でクラッシュ
   - 修正: 厳密な引用符検証とエラーハンドリング

2. **メモリリーク**: 大きなファイルでメモリ使用量が増大
   - 修正: ファイルサイズ制限とストリーミング処理

3. **無限ループ**: 特定のCSV形式で無限ループ
   - 修正: ループカウンターによる制限

4. **文字エンコーディング**: 日本語文字の破損
   - 修正: UTF-8エンコーディングの明示的指定

5. **データ検証不足**: 不正なデータの処理
   - 修正: 包括的なフィールド検証

## パフォーマンス指標

### 処理時間（目安）
- 100行のCSV: < 10ms
- 1000行のCSV: < 100ms
- 10000行のCSV: < 1000ms

### メモリ使用量
- 最大ファイルサイズ: 10MB
- 最大CSV行長: 50,000文字
- 最大フィールド長: 10,000文字

## 継続的な改善

### 今後の改善案
1. **より多くのエッジケース**: 新しい問題が発見された場合
2. **パフォーマンス最適化**: 大量データの処理速度向上
3. **国際化対応**: 他言語でのエラーメッセージ
4. **自動化**: CI/CDパイプラインでの自動テスト実行

### 新しいテストの追加方法

1. `test-data.js` に新しいテストデータを追加
2. `csv-manager.test.js` に新しいテストケースを追加
3. `test-runner.html` でテストを実行して確認

例：
```javascript
// test-data.js
TestData.edge.newCase = `フォルダ,タイトル,プロンプト,適用範囲
新しいケース,テストタイトル,テストプロンプト,both`;

// csv-manager.test.js
test.it('should handle new edge case', () => {
  const result = csvManager._parseCSVContent(TestData.edge.newCase);
  test.expect(result).toHaveLength(1);
  test.expect(result[0].folder).toBe('新しいケース');
});
```

## トラブルシューティング

### テストが失敗する場合
1. ブラウザの開発者ツールでエラーを確認
2. CSV Manager のバージョンが最新か確認
3. テストデータが正しく読み込まれているか確認

### 新しいバグを発見した場合
1. 再現可能な最小限のテストケースを作成
2. 期待される結果と実際の結果を記録
3. test-data.js に追加してテストスイートを拡張

## 参考リンク

- [Chrome Extension Testing Best Practices](https://developer.chrome.com/docs/extensions/mv3/testing/)
- [CSV Format Specification](https://tools.ietf.org/html/rfc4180)
- [JavaScript Testing Best Practices](https://github.com/goldbergyoni/javascript-testing-best-practices)